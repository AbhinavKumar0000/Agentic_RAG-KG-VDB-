<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cortex</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
    <div class="flash-container" id="flashContainer"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar glass-panel">
            <div class="brand">Cortex<span class="brand-highlight">RAG</span></div>

            <div class="control-section">
                <div class="section-label">Data Source</div>
                <div class="file-input-wrapper">
                    <label for="fileInput" class="file-label" id="fileName">Select Document</label>
                    <input type="file" id="fileInput" onchange="updateFileName()" hidden>
                </div>
                <button class="btn" id="uploadBtn" onclick="uploadFile()">
                    Process Data
                </button>
            </div>

            <div class="control-section">
                <div class="section-label">Visualization</div>
                <button class="btn btn-secondary" onclick="showGraph('3d')">
                    View 3D Graph
                </button>
                <button class="btn btn-secondary" onclick="showGraph('2d')">
                    View 2D Network
                </button>
            </div>

            <button class="btn btn-danger" onclick="resetDatabase()">
                Reset System
            </button>
        </aside>

        <!-- Main Chat -->
        <main class="main-content glass-panel">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <div class="loading-text" id="statusText">Processing...</div>
                <button class="btn btn-danger" onclick="cancelLoading()"
                    style="margin-top: 20px; padding: 6px 12px; font-size: 12px;">Cancel</button>
            </div>

            <div class="chat-area" id="chatBox">
                <div class="message bot">
                    Welcome to Cortex. Upload a document to begin analysis.
                </div>
            </div>

            <div class="input-bar">
                <input type="text" class="text-input" id="userInput" placeholder="Ask a question..."
                    onkeypress="handleEnter(event)">
                <button class="btn" onclick="sendMessage()" style="padding: 10px 14px;">Send</button>
            </div>
        </main>
    </div>

    <!-- Graph Modal -->
    <div id="graphModal" class="modal">
        <div class="close-modal" onclick="closeGraph()">Ã—</div>
        <div class="modal-content">
            <iframe id="graph-frame" src=""></iframe>
        </div>
    </div>

    <script>
        // --- Session Management ---
        let username = localStorage.getItem("rag_username");
        if (!username) {
            username = "User_" + Math.floor(1000 + Math.random() * 9000);
            localStorage.setItem("rag_username", username);
        }

        // --- UI Interactions ---
        function updateFileName() {
            const file = document.getElementById("fileInput").files[0];
            if (file) document.getElementById("fileName").innerText = file.name;
        }

        function showFlash(message, type = 'info') {
            const container = document.getElementById('flashContainer');
            const flash = document.createElement('div');
            flash.className = `flash-message ${type}`;
            flash.innerText = message;
            container.appendChild(flash);
            setTimeout(() => {
                flash.style.opacity = '0';
                flash.style.transform = 'translateX(20px)';
                setTimeout(() => flash.remove(), 300);
            }, 3000);
        }

        // --- Polling Logic ---
        let pollInterval = null;
        let idleCount = 0;

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            const overlay = document.getElementById("loadingOverlay");
            const statusText = document.getElementById("statusText");
            overlay.style.display = "flex";
            idleCount = 0;

            pollInterval = setInterval(async () => {
                try {
                    const res = await fetch("/status", { headers: { "X-User-ID": username } });
                    const data = await res.json();
                    statusText.innerText = data.status;

                    if (data.status === "Graph Ready" || data.status.startsWith("Error")) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        setTimeout(() => {
                            overlay.style.display = "none";
                            if (data.status === "Graph Ready") {
                                showFlash("Processing Complete", "success");
                                addMessage("Knowledge graph constructed. Ready for queries.", "bot");
                            } else {
                                showFlash(data.status, "error");
                                addMessage(data.status, "bot");
                            }
                            resetUploadBtn();
                        }, 800);
                    } else if (data.status === "Idle") {
                        idleCount++;
                        if (idleCount > 10) {
                            clearInterval(pollInterval);
                            pollInterval = null;
                            overlay.style.display = "none";
                            showFlash("Connection Timeout", "error");
                            resetUploadBtn();
                        }
                    } else {
                        idleCount = 0;
                    }
                } catch (e) {
                    console.error(e);
                }
            }, 1000);
        }

        function cancelLoading() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = null;
            document.getElementById("loadingOverlay").style.display = "none";
            resetUploadBtn();
            showFlash("Cancelled", "info");
        }

        function resetUploadBtn() {
            const btn = document.getElementById("uploadBtn");
            btn.disabled = false;
            btn.innerText = "Process Data";
        }

        // --- API Actions ---
        async function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) return showFlash("Select a document first", "error");

            const btn = document.getElementById("uploadBtn");
            btn.disabled = true;
            btn.innerText = "Processing...";

            const formData = new FormData();
            formData.append("file", file);

            startPolling();

            try {
                const res = await fetch("/upload", {
                    method: "POST",
                    headers: { "X-User-ID": username },
                    body: formData
                });
                if (!res.ok) throw new Error("Upload failed");
            } catch (e) {
                showFlash(e.message, "error");
                cancelLoading();
            }
        }

        async function resetDatabase() {
            if (!confirm("Reset the entire knowledge base?")) return;
            try {
                await fetch("/reset", {
                    method: "POST",
                    headers: { "X-User-ID": username }
                });
                showFlash("System Reset", "success");
                addMessage("System memory cleared.", "bot");
            } catch (e) {
                showFlash("Reset Failed", "error");
            }
        }

        async function sendMessage() {
            const input = document.getElementById("userInput");
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, "user");
            input.value = "";

            // Thinking Indicator
            const thinkingId = addMessage("Thinking...", "bot", false, true);

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "X-User-ID": username },
                    body: JSON.stringify({ message: text })
                });
                const data = await res.json();

                document.getElementById(thinkingId).remove();
                addMessage(marked.parse(data.response), "bot", true, data.tool);
            } catch (e) {
                document.getElementById(thinkingId).remove();
                showFlash("Network Error", "error");
                addMessage("Unable to process request.", "bot");
            }
        }

        // --- Graph Visualization ---
        async function showGraph(mode) {
            try {
                const res = await fetch(`/visualize/${mode}`, { headers: { "X-User-ID": username } });
                if (res.status === 404) return showFlash("No data available", "error");

                const data = await res.json();
                const iframe = document.getElementById("graph-frame");
                iframe.src = data.url + "?t=" + Date.now();
                document.getElementById("graphModal").style.display = "flex";
            } catch (e) {
                showFlash("Visualization Error", "error");
            }
        }

        function closeGraph() {
            document.getElementById("graphModal").style.display = "none";
            document.getElementById("graph-frame").src = "";
        }

        // --- Chat Utils ---
        function addMessage(text, sender, isHtml = false, tool = null) {
            const div = document.createElement("div");
            div.className = `message ${sender}`;
            if (tool === true) div.id = "temp-" + Date.now(); // Temp message flag hack

            let content = text;
            if (tool && tool !== true) {
                content += ` <span style="font-size:10px; opacity:0.7; margin-left:8px; border:1px solid rgba(255,255,255,0.2); padding:2px 6px; border-radius:4px;">${tool}</span>`;
            }

            if (isHtml || tool) div.innerHTML = content;
            else div.innerText = content;

            const box = document.getElementById("chatBox");
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div.id;
        }

        function handleEnter(e) {
            if (e.key === "Enter") sendMessage();
        }
    </script>
</body>

</html>